#!/usr/bin/make -f
# -*- makefile -*-
# Sample debian/rules that uses debhelper.
# GNU copyright 1997 to 1999 by Joey Hess.
#
# Modified to make a template file for a multi-binary package with separated
# build-arch and build-indep targets  by Bill Allombert 2001

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This has to be exported to make some magic below work.
#export DH_OPTIONS

include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/class/autotools.mk
include /usr/share/cdbs/1/rules/dpatch.mk

unpatch: deapply-dpatches

DEB_CONFIGURE_EXTRA_FLAGS := --with-optim=$(DEB_OPTFLAGS) --libdir=/usr/lib --mandir=/usr/share/man --with-docdir=/usr/share/cups/doc-root --enable-slp --enable-libpaper --enable-ssl --enable-gnutls --disable-openssl --enable-threads --enable-static --enable-dbus --disable-pdftops --disable-launchd --with-cups-user=lp --with-cups-group=lp --with-system-groups=lpadmin
DEB_MAKE_INSTALL_TARGET := install BUILDROOT=$(DEB_DESTDIR)
DEB_INSTALL_CHANGELOGS_ALL := CHANGES.txt
DEB_DH_STRIP_ARGS := --dbg-package=cupsys-dbg
DEB_DH_FIXPERMS_ARGS := -Xusr/lib/cups/backend-available

clean::
	-rm core
	-$(MAKE) clean
	-rm man/*.gz man/*.z man/*.1 man/*.5 man/*.8 man/*.o man/mantohtml
	-rm -f doc/help/man-*.html doc/help/standard.html doc/index.html
	-rm -f conf/pam.std packaging/cups.list templates/edit-config.tmpl
	-rm cups/libcups.so
	-rm cups/libcups.a
	-rm filter/libcupsimage.so
	-rm filter/libcupsimage.a
	-rm pdftops/libxpdf.a
	-rm scheduler/testdirsvc scheduler/testdirsvc.o
	-rm cups/testfile cups/testfile.o cups/http-addrlist.o
	-rm backend/http backend/runloop.o backend/ieee1284.o
	-rm systemv/disable systemv/enable systemv/reject
	-rm cups-config cups.list conf/cupsd.conf conf/pam.conf
	-rm config.log config.h config.cache config.status Makedefs cups.sh
	-rmdir --ignore-fail-on-non-empty debian/patched
	-rm -f man/client.conf.man man/cups-deviced.man man/cups-driverd.man man/cups-lpd.man man/cupsaddsmb.man man/cupsd.man man/cupsd.conf.man man/lpoptions.man templates/header.tmpl templates/edit-config.tmpl init/cups.sh init/cups-lpd
	-for l in de es et ja pl sv; do \
	  rm -f doc/$l/index.html; \
	  rm -f templates/$l/header.tmpl templates/$l/edit-config.tmpl; \
	done

common-install-prehook-impl::
	(cd fonts && $(MAKE) install BUILDROOT=$(DEB_DESTDIR))
$(patsubst %,install/%,$(DEB_ALL_PACKAGES)) :: install/%:
	dh_movefiles -p$(cdbs_curpkg)
binary-post-install/cupsys::
	mv debian/cupsys/usr/lib/cups/backend/* debian/cupsys/usr/lib/cups/backend-available
	install -o root -g root -m 644 doc/favicon.ico debian/cupsys/usr/share/cups/doc-root
	(cd $(DEB_DESTDIR) && mv var/spool var/log $(DEB_DESTDIR)/../cupsys/var)
	(cd $(DEB_DESTDIR) && mv etc/cups/interfaces etc/cups/ppd $(DEB_DESTDIR)/../cupsys/etc/cups)
	(cd $(DEB_DESTDIR)/../cupsys/usr/share/doc/cupsys && ln -sf ../../cups/doc-root online-docs)
	#(cd $(DEB_DESTDIR)/../cupsys/usr/share/man && mv man1/backend.1 man1/cups-backend.1 && mv man1/filter.1 man1/cups-filter.1)
	(install -m 755 -o root -g root $(DEB_DESTDIR)/../pdftops $(DEB_DESTDIR)/../cupsys/usr/lib/cups/filter/)
	install -o root -g root -m 644 debian/cupsys.default debian/cupsys/etc/default/cupsys
	install -m 755 debian/local/browsing_status debian/local/enable_browsing debian/local/sharing_status debian/local/enable_sharing $(DEB_DESTDIR)/../cupsys/usr/share/cups

	# Install PPDs into /usr/share/ppd/cups-included/<Manufacturer>, see
	# http://wiki.debian.org/PpdFileStructureSpecification
	for i in $(DEB_DESTDIR)/../cupsys/usr/share/cups/model/*.ppd; do \
	  m=$$(sed -n -e '/^\*Manufacturer:/s/.*"\([^"]*\)".*/\1/p' $$i); \
	  mkdir -p "$(DEB_DESTDIR)/../cupsys/usr/share/ppd/cups-included/$$m"; \
	  mv $$i "$(DEB_DESTDIR)/../cupsys/usr/share/ppd/cups-included/$$m/"; \
	done

	# Add symlink to local files required by LSB
	ln -s /usr/local/share/ppd $(DEB_DESTDIR)/../cupsys/usr/share/ppd/1-local-admin
	ln -s /opt/share/ppd $(DEB_DESTDIR)/../cupsys/usr/share/ppd/2-third-party

	# Compatibility for programs which still look in the old location
	#ln -s ../../ppd/cups-included $(DEB_DESTDIR)/../cupsys/usr/share/cups/model/cups-included
	#ln -s ../cups/model $(DEB_DESTDIR)/../cupsys/usr/share/ppd/cups-transitional-dir

binary-post-install/libcupsimage2-dev::
	rm -r debian/libcupsimage2-dev/usr/share/doc/libcupsimage2-dev
	ln -s libcupsimage2 debian/libcupsimage2-dev/usr/share/doc/libcupsimage2-dev
#binary-post-install/libcupsys2-gnutls10::
#	rm -r debian/libcupsys2-gnutls10/usr/share/doc/libcupsys2-gnutls10
#	ln -s libcupsys2 debian/libcupsys2-gnutls10/usr/share/doc/libcupsys2-gnutls10
binary-post-install/cupsys-bsd::
	rm -r debian/cupsys-bsd/usr/share/doc/cupsys-bsd
	ln -s libcupsys2 debian/cupsys-bsd/usr/share/doc/cupsys-bsd
binary-post-install/libcupsys2-dev::
	rm -r debian/libcupsys2-dev/usr/share/doc/libcupsys2-dev
	ln -s libcupsys2 debian/libcupsys2-dev/usr/share/doc/libcupsys2-dev
binary-post-install/cupsys-client::
	rm -r debian/cupsys-client/usr/share/doc/cupsys-client
	ln -s libcupsys2 debian/cupsys-client/usr/share/doc/cupsys-client
