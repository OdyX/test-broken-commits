#!/usr/bin/make -f
# -*- makefile -*-
# Sample debian/rules that uses debhelper.
# GNU copyright 1997 to 1999 by Joey Hess.
#
# Modified to make a template file for a multi-binary package with separated
# build-arch and build-indep targets  by Bill Allombert 2001

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This has to be exported to make some magic below work.
#export DH_OPTIONS

include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/class/autotools.mk
include /usr/share/cdbs/1/rules/dpatch.mk

unpatch: deapply-dpatches

# workaround for http://bugs.debian.org/469517
ifneq ($(findstring $(DEB_BUILD_ARCH), arm armel),)
  CFLAGS += -fno-stack-protector
endif

DEB_CONFIGURE_EXTRA_FLAGS := --with-optim=$(DEB_OPTFLAGS) --libdir=/usr/lib --mandir=/usr/share/man --with-docdir=/usr/share/cups/doc-root --localedir=/usr/share/cups/locale --enable-slp --enable-libpaper --enable-ssl --enable-gnutls --disable-openssl --enable-threads --enable-static --enable-dbus --enable-gssapi --disable-pdftops --disable-launchd --with-cups-group=lp --with-system-groups=lpadmin --with-printcap=/var/run/cups/printcap --with-log-file-perm=0640 CFLAGS="$(CFLAGS)"
DEB_MAKE_INSTALL_TARGET := install BUILDROOT=$(DEB_DESTDIR)
DEB_INSTALL_CHANGELOGS_ALL := CHANGES.txt
DEB_DH_INSTALLINIT_ARGS := -u'start 20 2 3 4 5 . stop 80 1 .'
DEB_DH_STRIP_ARGS := --dbg-package=cups-dbg
DEB_DH_FIXPERMS_ARGS := -Xusr/lib/cups/backend-available
DEB_DH_COMPRESS_ARGS := -Xusr/share/doc/libcups2-dev/examples/scripting
DEB_DH_INSTALL_SOURCEDIR := debian/tmp
ifneq ($(findstring $(DEB_BUILD_ARCH), arm m68k),)
DEB_MAKE_CHECK_TARGET := check || true
else
DEB_MAKE_CHECK_TARGET := check
endif
LDFLAGS := -Wl,--as-needed

common-post-build-arch::
	# Fix permissions of filters/backends installed from debian/local/
	chmod 755 debian/local/filters/*
	chmod 755 debian/local/backends/*
	# Build extra filters for PDF printing workflow
	# We have removed README.jp from all source trees, as it caused
	# packaging problems. So do not try to install these files.
	(cd debian/local/filters; perl -p -i -e 's/README.jp//g' */Makefile*)
	# Link CUPS headers so that filter build process finds them
	[ -r $(CURDIR)/cups/raster.h ] || \
		ln -s $(CURDIR)/filter/raster.h $(CURDIR)/cups/
	[ -r $(CURDIR)/cups/image.h ] || \
		ln -s $(CURDIR)/filter/image.h $(CURDIR)/cups/
	(cd debian/local/filters/imagetopdf; export CFLAGS="$$CFLAGS -I$(CURDIR)"; export CXXFLAGS="$$CFLAGS -I$(CURDIR)"; export LDFLAGS="$$LDFLAGS -L$(CURDIR)/cups/ -L$(CURDIR)/filter/"; touch NEWS AUTHORS ChangeLog; autoreconf --install; ./configure --prefix=/usr --sysconfdir=/etc; $(MAKE) imagetopdf_CFLAGS="")
	(cd debian/local/filters/pdftopdf; export CFLAGS="$$CFLAGS -I$(CURDIR)"; export CXXFLAGS="$$CFLAGS -I$(CURDIR)"; export LDFLAGS="$$LDFLAGS -L$(CURDIR)/cups/ -L$(CURDIR)/filter/"; touch NEWS AUTHORS ChangeLog; autoreconf --install; ./configure --prefix=/usr --sysconfdir=/etc; $(MAKE))
	(cd debian/local/filters/pdftoraster; export CFLAGS="$$CFLAGS -I$(CURDIR)"; export CXXFLAGS="$$CFLAGS -I$(CURDIR)"; export LDFLAGS="$$LDFLAGS -L$(CURDIR)/cups/ -L$(CURDIR)/filter/"; touch NEWS AUTHORS ChangeLog; autoreconf --install; ./configure --prefix=/usr --sysconfdir=/etc; $(MAKE))

clean::
	rm -f man/client.conf.man packaging/cups.list
	rm -f conf/mime.convs conf/snmp.conf init/org.cups.cups-lpd.plist
	# Clean source trees of extra filters for PDF printing workflow
	-(cd debian/local/filters/imagetopdf;$(MAKE) distclean)
	-(cd debian/local/filters/pdftopdf;$(MAKE) distclean)
	-(cd debian/local/filters/pdftoraster;$(MAKE) distclean)
	# Remove all auxiliary files created by this rules file 
	rm -f cups/raster.h cups/image.h

common-install-prehook-impl::
	(cd fonts && $(MAKE) install BUILDROOT=$(DEB_DESTDIR))

binary-post-install/cups::
	(cd $(DEB_DESTDIR)/../cups/usr/share/doc/cups && ln -sf ../../cups/doc-root online-docs)

	# Install PPDs into /usr/share/ppd/cups-included/<Manufacturer>, see
	# http://wiki.debian.org/PpdFileStructureSpecification
	for i in $(DEB_DESTDIR)/../cups/usr/share/cups/model/*.ppd; do \
	  m=$$(sed -n -e '/^\*Manufacturer:/s/.*"\([^"]*\)".*/\1/p' $$i); \
	  mkdir -p "$(DEB_DESTDIR)/../cups/usr/share/ppd/cups-included/$$m"; \
	  mv $$i "$(DEB_DESTDIR)/../cups/usr/share/ppd/cups-included/$$m/"; \
	done
	rmdir $(DEB_DESTDIR)/../cups/usr/share/cups/model

	dh_usrlocal

	# Install DBUS configuration file so that job progress is reported to
	# the system-config-printer applet
	install -D -m 644 packaging/cups-dbus.conf $(DEB_DESTDIR)/../cups/etc/dbus-1/system.d/cups.conf

	# Install AppArmor profile on Ubuntu
	if [ "`lsb_release -is 2>/dev/null`" = "Ubuntu" ]; then \
	   install -D -m 644 debian/local/apparmor-profile debian/$(cdbs_curpkg)/etc/apparmor.d/usr.sbin.cupsd; \
	fi

	# Install extra filters for PDF printing workflow
	(cd debian/local/filters/imagetopdf;make install DESTDIR=$(DEB_DESTDIR)/../cups)
	(cd debian/local/filters/pdftopdf;make install DESTDIR=$(DEB_DESTDIR)/../cups)
	(cd debian/local/filters/pdftoraster;make install DESTDIR=$(DEB_DESTDIR)/../cups)
	mv $(DEB_DESTDIR)/../cups/usr/share/doc/imagetopdf $(DEB_DESTDIR)/../cups/usr/share/doc/cups
	mv $(DEB_DESTDIR)/../cups/usr/share/doc/pdftopdf $(DEB_DESTDIR)/../cups/usr/share/doc/cups
	mv $(DEB_DESTDIR)/../cups/usr/share/doc/pdftoraster $(DEB_DESTDIR)/../cups/usr/share/doc/cups
	# Move file detection and conversion rules to /usr/share/cups/mime/ so
	# that the package manager does not consider them conffiles
	install -d $(DEB_DESTDIR)/../cups/usr/share/cups/mime
	( cd $(DEB_DESTDIR)/../cups/etc/cups; mv imagetopdf.* pdftopdf.* pdftoraster.* pdf.* $(DEB_DESTDIR)/../cups/usr/share/cups/mime/ )
	# Simple Ghostscript-based PostScript-to-PDF filter
	install -m 0755 debian/filters/pstopdf $(DEB_DESTDIR)/../cups/usr/lib/cups/filter

binary-post-install/libcupsimage2-dev::
	rm -r debian/libcupsimage2-dev/usr/share/doc/libcupsimage2-dev
	ln -s libcupsimage2 debian/libcupsimage2-dev/usr/share/doc/libcupsimage2-dev
binary-post-install/cups-bsd::
	rm -r debian/cups-bsd/usr/share/doc/cups-bsd
	ln -s libcups2 debian/cups-bsd/usr/share/doc/cups-bsd
binary-post-install/libcups2-dev::
	rm -f debian/$(cdbs_curpkg)/usr/share/doc/$(cdbs_curpkg)/examples/scripting/php/*.o
	rm -f debian/$(cdbs_curpkg)/usr/share/doc/$(cdbs_curpkg)/examples/scripting/php/*.so
binary-post-install/cups-client::
	rm -r debian/cups-client/usr/share/doc/cups-client
	ln -s libcups2 debian/cups-client/usr/share/doc/cups-client
